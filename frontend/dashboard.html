<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>داشبورد - سیستم مدیریت کلینیک</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; }
        .sidebar { height: 100vh; position: fixed; right: 0; top: 0; width: 250px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding-top: 20px; }
        .sidebar a { color: white; text-decoration: none; padding: 12px 20px; display: block; transition: 0.3s; }
        .sidebar a:hover, .sidebar a.active { background-color: rgba(255,255,255,0.2); }
        .main-content { margin-right: 250px; padding: 20px; }
        .stat-card { border-left: 4px solid #667eea; }
        .table-actions button { margin: 0 2px; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="text-center mb-4">
            <h5 class="text-white"><i class="bi bi-hospital"></i> کلینیک</h5>
            <p class="text-white-50 small" id="userName"></p>
        </div>
        <a href="dashboard.html" class="active"><i class="bi bi-speedometer2"></i> داشبورد</a>
        <a href="patients.html" id="patientsLink"><i class="bi bi-people"></i> بیماران</a>
        <a href="appointments.html"><i class="bi bi-calendar-check"></i> نوبت‌ها</a>
        <a href="prescriptions.html"><i class="bi bi-prescription2"></i> نسخه‌ها</a>
        <a href="medications.html" id="medicationsLink"><i class="bi bi-capsule"></i> داروها</a>
        <a href="factors.html"><i class="bi bi-file-earmark-medical"></i> فاکتورها</a>
        <a href="insurance.html"><i class="bi bi-shield-check"></i> بیمه</a>
        <a href="support.html"><i class="bi bi-chat-dots"></i> پشتیبانی</a>
        <a href="reports.html" id="reportsLink"><i class="bi bi-graph-up"></i> گزارشات</a>
        <a href="settings.html" id="settingsLink"><i class="bi bi-gear"></i> تنظیمات</a>
        <hr class="bg-white">
        <a href="#" onclick="logout()"><i class="bi bi-box-arrow-right"></i> خروج</a>
    </div>

    <div class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>داشبورد</h2>
            <div>
                <span class="badge bg-success" id="userRole"></span>
            </div>
        </div>

        <div class="row g-3 mb-4" id="statsSection">
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="text-muted">بیماران</h6>
                                <h3 id="totalPatients">0</h3>
                            </div>
                            <i class="bi bi-people text-primary" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="text-muted">نوبت‌های امروز</h6>
                                <h3 id="todayAppointments">0</h3>
                            </div>
                            <i class="bi bi-calendar-check text-success" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="text-muted">نسخه‌های جدید</h6>
                                <h3 id="newPrescriptions">0</h3>
                            </div>
                            <i class="bi bi-prescription2 text-info" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="text-muted">داروها</h6>
                                <h3 id="totalMedications">0</h3>
                            </div>
                            <i class="bi bi-capsule text-warning" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">نوبت‌های امروز</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>بیمار</th>
                                        <th>زمان</th>
                                        <th>وضعیت</th>
                                        <th>عملیات</th>
                                    </tr>
                                </thead>
                                <tbody id="appointmentsTable">
                                    <tr><td colspan="4" class="text-center">در حال بارگذاری...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">دسترسی سریع</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary" onclick="location.href='appointments.html'">
                                <i class="bi bi-plus-circle"></i> نوبت جدید
                            </button>
                            <button class="btn btn-outline-success" onclick="location.href='patients.html'" id="newPatientBtn">
                                <i class="bi bi-person-plus"></i> بیمار جدید
                            </button>
                            <button class="btn btn-outline-info" onclick="location.href='prescriptions.html'">
                                <i class="bi bi-file-plus"></i> نسخه جدید
                            </button>
                            <button class="btn btn-outline-warning" onclick="location.href='support.html'">
                                <i class="bi bi-chat"></i> پشتیبانی
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = 'http://localhost:1212';
        let token = localStorage.getItem('access_token');
        let user = JSON.parse(localStorage.getItem('user') || '{}');

        if (!token) {
            window.location.href = 'index.html';
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('userName').textContent = user.full_name;
            document.getElementById('userRole').textContent = getRoleName(user.role);
            
            setupMenuAccess();
            loadDashboardData();
        });

        function setupMenuAccess() {
            if (user.role === 'Patient') {
                document.getElementById('patientsLink').style.display = 'none';
                document.getElementById('medicationsLink').style.display = 'none';
                document.getElementById('reportsLink').style.display = 'none';
                document.getElementById('settingsLink').style.display = 'none';
                document.getElementById('newPatientBtn').style.display = 'none';
                document.getElementById('statsSection').style.display = 'none';
            }
        }

        function getRoleName(role) {
            const roles = { 'Admin': 'مدیر', 'Secretary': 'منشی', 'Patient': 'بیمار' };
            return roles[role] || role;
        }

        async function loadDashboardData() {
            try {
                if (user.role !== 'Patient') {
                    await Promise.all([
                        loadPatients(),
                        loadAppointments(),
                        loadMedications()
                    ]);
                }
                await loadTodayAppointments();
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        async function loadPatients() {
            try {
                const response = await apiCall('/api/v1/patients/patients/');
                if (response) {
                    document.getElementById('totalPatients').textContent = response.length;
                }
            } catch (error) {
                console.error('Error loading patients:', error);
            }
        }

        async function loadAppointments() {
            try {
                const response = await apiCall('/api/v1/appointments/appointments/');
                if (response) {
                    const today = new Date().toISOString().split('T')[0];
                    const todayAppts = response.filter(a => a.appointment_date.startsWith(today));
                    document.getElementById('todayAppointments').textContent = todayAppts.length;
                }
            } catch (error) {
                console.error('Error loading appointments:', error);
            }
        }

        async function loadMedications() {
            try {
                const response = await apiCall('/api/v1/medications/medications/');
                if (response) {
                    document.getElementById('totalMedications').textContent = response.length;
                }
            } catch (error) {
                console.error('Error loading medications:', error);
            }
        }

        async function loadTodayAppointments() {
            const endpoint = user.role === 'Patient' 
                ? '/api/v1/appointments/appointments/my'
                : '/api/v1/appointments/appointments/';
            
            try {
                const response = await apiCall(endpoint);
                const tbody = document.getElementById('appointmentsTable');
                
                if (response && response.length > 0) {
                    const today = new Date().toISOString().split('T')[0];
                    const todayAppts = response.filter(a => a.appointment_date.startsWith(today)).slice(0, 5);
                    
                    tbody.innerHTML = todayAppts.map(apt => `
                        <tr>
                            <td>${apt.patient_name || 'نامشخص'}</td>
                            <td>${new Date(apt.appointment_date).toLocaleTimeString('fa-IR', {hour: '2-digit', minute: '2-digit'})}</td>
                            <td><span class="badge bg-${getStatusColor(apt.status)}">${getStatusText(apt.status)}</span></td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="viewAppointment(${apt.id})">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center">نوبتی برای امروز وجود ندارد</td></tr>';
                }
            } catch (error) {
                document.getElementById('appointmentsTable').innerHTML = '<tr><td colspan="4" class="text-center text-danger">خطا در بارگذاری اطلاعات</td></tr>';
            }
        }

        function getStatusColor(status) {
            const colors = { 'Pending': 'warning', 'Confirmed': 'info', 'Completed': 'success', 'Canceled': 'danger' };
            return colors[status] || 'secondary';
        }

        function getStatusText(status) {
            const texts = { 'Pending': 'در انتظار', 'Confirmed': 'تایید شده', 'Completed': 'انجام شده', 'Canceled': 'لغو شده' };
            return texts[status] || status;
        }

        function viewAppointment(id) {
            window.location.href = `appointments.html?id=${id}`;
        }

        async function apiCall(endpoint, options = {}) {
            const response = await fetch(`${API_URL}${endpoint}`, {
                ...options,
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });

            if (response.status === 401) {
                logout();
                return null;
            }

            if (!response.ok) throw new Error('API call failed');
            return response.json();
        }

        function logout() {
            localStorage.clear();
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>